import { Callout } from "nextra-theme-docs";

# æ‹“å±•æ–°çš„æœåŠ¡æ¨¡å—

> æ–‡ç« æ¥è‡ª [å¯æ„›ã„æ¾ | NestJS å¾®æœåŠ¡é€šè¿‡è®¢é˜…å‘å¸ƒäº‹ä»¶ä¸å…¶ä»–æŠ€æœ¯æ ˆäº¤äº’](https://blog.iucky.cn/posts/programming/use-nestjs-microservice-with-other-tech), ä½†åŸºäº Mog åšäº†éƒ¨åˆ†è¡¥å……

<Callout emoji="ğŸš§" title="æ³¨æ„">
æ­¤æ–‡ç« ä»…è€ƒè™‘çš„æ˜¯ NestJS Gateway åœºæ™¯ä¸‹ï¼Œå¯¹äºå…¶ä»–æƒ…å†µæš‚æ—¶ä¸åšè§£é‡Šï¼ŒæŒ‰ç†æ¥è¯´åº”è¯¥ä½ ä¹Ÿèƒ½ç†è§£ã€‚

æ­¤å¤–ï¼Œè¿™ç¯‡æ–‡ç« ä½¿ç”¨çš„æ˜¯ Redis ä½œä¸ºä¼ è¾“å±‚ï¼Œä½ éœ€è¦çŸ¥é“åŸºæœ¬æ“ä½œæ‰èƒ½æ¥çœ‹æ­¤æ–‡ç« ï¼Œå¹¶ä¸”æ­¤æ–‡ç« ä»…è®²è¿°äº¤äº’åŸç†ã€‚
</Callout>

å¦‚æœä½ æƒ³ç›´æ¥è¶Šè¿‡è§£é‡Šå‰å¾€å®è·µï¼Œå¯ä»¥ç›´æ¥çœ‹ [ä½¿ç”¨ NodeJS å†™ä¸€ä¸ªå¾®æœåŠ¡](#ä½¿ç”¨-nodejs-å†™ä¸€ä¸ªå¾®æœåŠ¡) è¿™ä¸€èŠ‚

## åˆ›å»ºä¸€ä¸ªå¾®æœåŠ¡æ¨¡å—


ä½¿ç”¨ `nest g app tester` NestJS CLI å°†ä¼šè‡ªåŠ¨å¸®ä½ åˆ›å»ºå¯¹åº”çš„æ¨¡å—ï¼Œä½†æ˜¯ä½ éœ€è¦è‡ªå·±ä¿®æ”¹éƒ¨åˆ†å†…å®¹ï¼Œæ¯”å¦‚åœ¨ main.tsï¼Œä½ éœ€è¦å°† `create` æ›¿æ¢ä¸º `createMicroservice`ï¼Œè¿˜æœ‰å…¶ä»–çš„ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯·å°† transporter è®¾ç½®ä¸º REDIS

```ts
const app = await NestFactory.createMicroservice<MicroserviceOptions>(
    YourModule,
    {
      transport: Transport.REDIS,
      options: {
        port: REDIS.port,
        host: REDIS.host,
        password: REDIS.password,
        username: REDIS.user,
      },
    },Ã
  );
await app.listen();
```

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ redis-cli æ¥ç›‘æ§äº‹ä»¶å˜åŒ–

```ts
redis-cli monitor
```

## ä½¿ç”¨å¾®æœåŠ¡è®¢é˜…äº‹ä»¶

ä¸ `@nestjs/common` ä¸­ä¸ä¸€æ ·çš„ `@Get()`ï¼Œä½ éœ€è¦ä½¿ç”¨åœ¨ microservices åŒ…å†…çš„ MessagePatternï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºèŒƒ

```ts
@MessagePattern({ cmd: "get.something" })
async getSomething() {
  console.log('getSomething');
}
```

æ¥ä¸‹æ¥ï¼Œå¯åŠ¨è¿™ä¸ªå¾®æœåŠ¡ï¼Œæ³¨æ„ä¸€ä¸‹ä¸Šæ–¹ redis-cli monitor å‡ºç°çš„æ—¥å¿—

```bash
1673269961.656461 [0 127.0.0.1:63956] "info"
1673269961.657177 [0 127.0.0.1:63957] "info"
1673269961.659145 [0 127.0.0.1:63956] "subscribe" " {\"cmd\":\"get.something\"}
```

çœ‹æ ·å­æˆ‘ä»¬æ‰¾åˆ°äº†ä¸€ä¸ªå¼€å§‹è®¢é˜…çš„äº‹ä»¶ï¼Œè®©æˆ‘ä»¬è®°ä½è¿™ä¸€ä¸ªäº‹ä»¶ï¼Œç»§ç»­ä¸‹å»ã€‚

> åç»­ï¼Œæˆ‘å°†ä½¿ç”¨ `user.get.master` æ¥ä»£æ›¿ `get.something` äº‹ä»¶
>
> å¦å¤–ï¼Œè¿™ç§äº‹ä»¶å‘½åæ–¹å¼å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œè¿™åªæ˜¯æˆ‘ä¸ªäººä¹ æƒ¯

## åœ¨ç½‘å…³å±‚è®¢é˜…äº‹ä»¶

ä½ éœ€è¦åœ¨ç½‘å…³å±‚æ¨¡å—ä¸­å¯¼å…¥ä¸€ä¸ª `ClientModule`ï¼š

```ts
ClientsModule.register([
      {
        name: "YOUR_MODULE",
        transport: Transport.REDIS,
        options: {
          port: REDIS.port,
          host: REDIS.host,
          password: REDIS.password,
          username: REDIS.user,
        },
      },
    ]),
```

ä¹‹ååœ¨ controller æ„é€ å‡½æ•°ä¸­æ³¨å…¥å®ƒï¼Œå†ä»»æ„æä¸€ä¸ªè¯·æ±‚ï¼š

```ts
constructor(
    @Inject("YOUR_MODULE") private readonly yourModule: ClientProxy,
  ) {}

@Get('/')
async getMaster() {
  return this.category.send({ cmd: "user.get.master" }, {})
}
```

è®©æˆ‘ä»¬ç»§ç»­å¯åŠ¨ç½‘å…³å±‚ï¼Œredis-cli monitor æ­¤æ—¶ä¸ä¼šå‡ºç°ä»»ä½•æ—¥å¿—ï¼Œè¿™æ˜¯æ­£å¸¸çš„

## å½“æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œäº‹ä»¶å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–

æˆ‘ä»¬è®¿é—®ä¸€ä¸‹ç½‘å…³å±‚ä¸­é…ç½®çš„è·¯å¾„ï¼Œæ³¨æ„ä¸€ä¸‹ redis-cli monitor å‡ºç°çš„æ—¥å¿—ï¼š

```bash
1673270738.710378 [0 127.0.0.1:64424] "subscribe" "{\"cmd\":\"user.get.master\"}.reply"
1673270738.710744 [0 127.0.0.1:64425] "publish" "{\"cmd\":\"user.get.master\"}" "{\"pattern\":{\"cmd\":\"user.get.master\"},\"data\":{},\"id\":\"6c1475df-b357-4bc9-8443-5f0f06bf8e0b\"}"
1673270738.781133 [0 127.0.0.1:64931] "publish" "{\"cmd\":\"user.get.master\"}.reply" "{\"response\":{\"_id\":\"638c311569199e8250503d80\",\"username\":\"wibus-wee\",\"nickname\":\"Wibus\",\"description\":\"\xe6\x88\x91\xe6\x98\xaf\xe7\xbb\x83\xe4\xb9\xa0\xe6\x97\xb6\xe9\x95\xbf\xe4\xb8\xa4\xe5\xb9\xb4\xe5\x8d\x8a\xe7\x9a\x84\xe4\xb8\xaa\xe4\xba\xba\xe7\xbb\x83\xe4\xb9\xa0\xe7\x94\x9f\",\"avatar\":\"http://example.com\",\"email\":\"example@example.com\",\"url\":\"http://example.com\",\"role\":0,\"created\":\"2022-12-04T05:33:09.526Z\",\"__v\":0,\"lastLoginTime\":\"2023-01-09T08:39:39.723Z\",\"id\":\"638c311569199e8250503d80\"},\"isDisposed\":true,\"id\":\"da1d3910-5e1b-4193-8637-9cbfdd8ebac1\"}"
1673270738.714335 [0 127.0.0.1:64424] "unsubscribe" "{\"cmd\":\"user.get.master\"}.reply"
```

è¿™æ—¥å¿—æœ‰ç‚¹è¾£çœ¼ç›ï¼Œè€Œä¸”è¿™ä¸ªæ˜¯æˆ‘ä»¬å¼€äº†ç½‘å…³å±‚ & å¾®æœåŠ¡å‡ºç°çš„æ—¥å¿—ï¼Œæˆ‘ä»¬æš‚æ—¶åªæƒ³çŸ¥é“ç½‘å…³å±‚ï¼Œæˆ‘ä»¬å°†ä¸Šé¢çš„å¾®æœåŠ¡å…³æ‰ï¼Œå†è®¿é—®ä¸€æ¬¡ï¼š

```bash
1673270936.835823 [0 127.0.0.1:64424] "subscribe" "{\"cmd\":\"user.get.master\"}.reply"
1673270936.836329 [0 127.0.0.1:64425] "publish" "{\"cmd\":\"user.get.master\"}" "{\"pattern\":{\"cmd\":\"user.get.master\"},\"data\":{},\"id\":\"f118b8f7-26ce-44dc-b8b0-592fceab1250\"}"
1673270939.835447 [0 127.0.0.1:64424] "unsubscribe" "{\"cmd\":\"user.get.master\"}.reply"
```

æˆ‘ä»¬ç²¾ç®€ä¸€ä¸‹ï¼Œå°†æ— ç”¨çš„æ•°æ®å»æ‰ï¼Œåªç•™ä¸‹æˆ‘ä»¬æƒ³è¦çš„ä¸œè¥¿å§ï¼š

```bash
"subscribe" "cmd.reply"
"publish" "cmd" "{\"pattern\":{\"cmd\":\"user.get.master\"},\"data\":{},\"id\":\"6c1475df-b357-4bc9-8443-5f0f06bf8e0b\"}"
"unsubscribe" "cmd.reply"
```

å¯ä»¥çœ‹åˆ°ç½‘å…³å±‚å…ˆè®¢é˜…äº†ä¸€ä¸ªåŸºäºä¹‹å‰æˆ‘ä»¬å®šä¹‰çš„ `user.get.master` çš„ reply äº‹ä»¶ï¼Œä¹‹åï¼Œåœ¨ `user.get.master` äº‹ä»¶ä¸Šå‘å¸ƒäº†æ•°æ®ï¼Œå°±æ˜¯å°† pattern, data, id å‘å¸ƒäº†ï¼Œååˆ†é‡è¦çš„å°±æ˜¯è¿™ä¸ªidï¼Œè¿™æ˜¯ç½‘å…³å±‚ä¸­ä¼ è¾“æ¥çš„ã€‚

å¯¹æ¯”ä¸€ä¸‹ï¼Œä½ å°±å¯ä»¥çŸ¥é“å…¶ä¸­æœ‰ä¸€ä¸ªç‰¹åˆ«é•¿çš„æ—¥å¿—å°±æ˜¯ç”±å¾®æœåŠ¡å‘å¸ƒçš„ï¼Œå¯ä»¥å‘ç°å¾®æœåŠ¡æ˜¯å‘ reply äº‹ä»¶å‘å¸ƒäº†äº‹ä»¶ï¼Œå†…å®¹è¿˜åŒ…å«äº†ä¹‹å‰æˆ‘ä»¬æåˆ°çš„ idï¼Œä¹‹åç½‘å…³å±‚æ”¶åˆ°äº†æ•°æ®è¿”å›ï¼Œæ¥ç€è¿”å›æ¥è‡ªå¾®æœåŠ¡çš„æ•°æ®ï¼Œå–æ¶ˆè®¢é˜…å¯¹åº”çš„äº‹ä»¶

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾æ¥è§£é‡Šä¸‹å§ï¼š

```mermaid
graph TD;
A[ç½‘å…³å±‚æ¥å—è¯·æ±‚] --> B[å¼€å§‹è®¢é˜… event.reply äº‹ä»¶]
A --> C[å‘ event å‘å¸ƒ data å’Œ id]
C --> D
B --> F
E --> F[ç½‘å…³å±‚æ”¶åˆ°æ¥è‡ª event.reply çš„æ•°æ®]
F --> G[å–æ¶ˆè®¢é˜… event.reply äº‹ä»¶]

AA[å¾®æœåŠ¡å¼€å§‹è®¢é˜… event äº‹ä»¶] --> D[å¾®æœåŠ¡æ”¶åˆ°æ¥è‡ª event çš„æ•°æ®]
D --> E[å‘ event.reply å‘å¸ƒæ•°æ®]
```

æ€»ç»“ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯è¿™æ ·çš„ï¼š

![SCR-20230109-nrl](https://cdn.my-api.cn/user/w/asset-pic-picgo/2023-01-202301092137599.png)

## ä½¿ç”¨ NodeJS å†™ä¸€ä¸ªå¾®æœåŠ¡

ä½¿ç”¨ pnpm å®‰è£…ä¸Š redisï¼Œæ ¹æ®ä¸Šæ–¹æˆ‘æ‰€è¯´çš„å†…å®¹ï¼ŒæŠ½å‡ºæ¥ä¸€äº›åŠŸèƒ½å‡½æ•°ï¼Œä»¥æé«˜å¯ç»´æŠ¤æ€§ã€‚

å› ä¸º [NestJS æ–‡æ¡£](https://docs.nestjs.com/microservices/basics) æœ‰è¯´åˆ°ä¸¤ç§æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯ `message` å’Œ `event`ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åšä¸€ä¸ªåˆ¤å®šå’Œå¿«æ·ç”Ÿæˆå¯¹åº”çš„ patternï¼š

```ts
/**
 * isEmitter åˆ¤æ–­æ˜¯å¦ä¸º event-based æ¨¡å¼
 * 
 * é€šè¿‡ JSON.stringify åˆ¤æ–­æ˜¯å¦ä¸º event-based æ¨¡å¼ã€‚
 * åŸç†ï¼šåœ¨ event-based æ¨¡å¼ä¸‹, pattern æ˜¯ä¸å¸¦ cmd çš„ã€‚
 *
 * PSï¼š`isEmitter` æ–¹æ³•å¯èƒ½åœ¨è¿™ä¸ªæ¡ˆä¾‹é‡Œé¢æ²¡æœ‰ç”¨ï¼Œä½†ä¸æ’é™¤æœ‰å…¶ä»–éœ€æ±‚æ—¶æ˜¯æœ‰ç”¨çš„
 * 
 * @param {string} pattern æ¨¡å¼
 * @returns boolean
 */
function isEmitter(pattern) {
  try {
    JSON.stringify(pattern)
    return false
  } catch {
    return true
  }
}

/**
 * å¿«æ·ç”Ÿæˆæ¨¡å¼
 * @param {string} pattern æ´»åŠ¨åç§°
 * @param {boolean} isEmit æ˜¯å¦ä¸º event-based æ¨¡å¼
 * @returns string
 */
function generagtePattern(pattern, isEmit) {
  if (!isEmit) {
    return JSON.stringify({ cmd: pattern })
  }
  return pattern
}
```

æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¿¡æ¯çš„ç»“æ„å§ï¼Œå¾ˆæ˜æ˜¾æ¥è‡ªGatewayçš„ä¿¡æ¯å¸¦æœ‰3ä¸ªkeyï¼špattern, data, idï¼Œå…¶ä¸­ id æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä¹Ÿæ˜¯è¿”å›å“åº”æ—¶å¿…è¦çš„ï¼›

å†åˆ†æä¸€ä¸‹NestJS Microservice æ˜¯æ€ä¹ˆå“åº”çš„ï¼Œå®ƒçš„ä¿¡æ¯ä¹Ÿå¸¦æœ‰3ä¸ªkeyï¼šresponse, isDispose, idï¼Œå…¶ä¸­ isDispose å¿…é¡»ä¸º trueï¼Œid å¿…é¡»æ˜¯æ¥è‡ª Gateway çš„ã€‚

```ts
/**
 * è§£ææ¥è‡ª NestJS Gateway å‘å¸ƒçš„ä¿¡æ¯
 * @param {string} message
 * @returns object
 */
function parseEventDataFromGateway(message) {
  message = JSON.parse(message)
  return {
    id: message.id,
    data: message.data,
    pattern: JSON.stringify(message.pattern),
    isEmitter: isEmitter(message.pattern),
  }
}

/**
 * ç”Ÿæˆå“åº”æ•°æ®
 * @param {string} id äº‹ä»¶ID
 * @param {string | object} data äº‹ä»¶æ•°æ®
 * @returns string
 */
function generagteResponse(id, data) {
  return JSON.stringify(
    {
      response: data,
      isDisposed: true,
      id,
    }
  )
}
```

æ‰€ä»¥å‰©ä¸‹çš„å°±æ˜¯åˆ›å»º redis client å’Œå‘å¸ƒ/è®¢é˜…äº‹ä»¶äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿”å›ç»™ Gateway çš„ä¿¡æ¯éœ€è¦åœ¨äº‹ä»¶ååŠ ä¸Š`.reply`ï¼Œä½ åœ¨ monitor ä¸Šä¹Ÿèƒ½çœ‹åˆ° Gateway åœ¨å‘å¸ƒäº‹ä»¶çš„æ—¶å€™ä¼šåŒæ—¶è®¢é˜…å¯¹åº”çš„replyäº‹ä»¶ï¼š

```ts
import { createClient } from 'redis';

const client = createClient()
const subscriber = client.duplicate();
await subscriber.connect();
const publisher = client.duplicate();
await publisher.connect();
const pattern = generagtePattern("<YOUR_EVENT_SETTING>", false)

await subscriber.subscribe(pattern, async (message) => {
  const { id, data, pattern, isEmitter } = parseEventDataFromGateway(message)
  console.log("Message: ", message)
  console.log("Event ID: ", id)
  console.log("Data: ", data)
  console.log("Pattern: ", pattern)
  console.log("isEmitter: ", isEmitter)
  // âš ï¸ æ³¨æ„ä¸‹è¿™é‡Œï¼Œè¿™ä¸ªçš„ event æ˜¯ pattern.replyï¼
  await publisher.publish(`${pattern}.reply`, generagteResponse(id, { name: 'test' }))
});
```

è¿™æ ·ä¾¿æ˜¯ä¸€ä¸ªç®€å•æ˜“å¯åŠ¨çš„æœåŠ¡å•¦ï¼ä½¿ç”¨ node^18 æ›´å¯ä»¥ä½¿ç”¨å…¶å®éªŒæ€§åŠŸèƒ½ï¼š`--watch` ç›´æ¥ç›‘å¬æ–‡ä»¶å˜åŒ–é‡è½½ç¨‹åº

```bash
node --watch service.js
```

![](https://cdn.my-api.cn/user/w/asset-pic-picgo/2023-01-202301102241094.jpeg)

## åœ¨ Mog Core ä¸­æ³¨å†Œäº‹ä»¶

åœ¨ Mog Core ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Gateway è¿è¡Œç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `events.yaml` æ–‡ä»¶ï¼Œå®ƒæ˜¯ç”¨äºæ³¨å†Œéå¸¸è§„äº‹ä»¶çš„ï¼Œå³éå®˜æ–¹å®ç°çš„äº‹ä»¶ï¼Œä¾‹å¦‚ï¼š`user.login`ï¼Œ`user.register` ç­‰ç­‰ã€‚

```yaml
render: # controller --> {API}/render/*
  - path: /events # {API}/render/events
    method: get
    handler: events.get # å‘å¸ƒæ´»åŠ¨
    emit: true # æ˜¯å¦ä¸º event-based æ¨¡å¼
  - path: /events/{id} # {API}/render/events/{id}
    method: get
    handler: events.get.id
```

å¦‚ä¸Šæ–¹ä¾‹å­ï¼Œå½“è¯·æ±‚ `{API}/render/events` æ—¶ï¼Œä¼šè§¦å‘ `events.get` äº‹ä»¶ï¼Œç”±äº `emit` ä¸º trueï¼Œå› æ­¤ Gateway ä¼šè§¦å‘ `events.get` äº‹ä»¶ï¼Œè€Œä¸ä¼šå¼€å§‹ç›‘å¬ `.reply` äº‹ä»¶ã€‚

ä½†æ˜¯ä¸‹æ–¹çš„ `events.get.id` äº‹ä»¶ï¼Œç”±äº `emit` ä¸º undefinedï¼Œå› æ­¤ Gateway ä¼šåŒæ—¶ç›‘å¬ `events.get.id` å’Œ `events.get.id.reply` äº‹ä»¶ï¼Œå¦‚æœä½ çš„æœåŠ¡æ²¡æœ‰è¿”å›å“åº”ï¼Œé‚£ä¹ˆ Gateway ä¼šåœ¨ 5 ç§’åè¿”å›ä¸€ä¸ªè¶…æ—¶çš„å“åº”ã€‚

## æ³¨æ„äº‹é¡¹

æ³¨æ„çš„æ˜¯ï¼šä¸€ä¸ªäº‹ä»¶åªèƒ½ç”±ä¸€ä¸ªæœåŠ¡å—ç†ï¼Œå¦åˆ™åˆ™ä¼šå‡ºç°å†²çªæƒ…å†µã€‚ä½†æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼ˆEvent-basedï¼‰å¯ä»¥è°ƒåº¦åˆ°å¤šä¸ªæ–¹æ³•

> You can register multiple event handlers for a single event pattern and all of them will be automatically triggered in parallel. -- [NestJS Documentaion](https://docs.nestjs.com/microservices/basics)

å› æ­¤ï¼Œåœ¨ç¼–ç çš„æ—¶å€™ï¼Œä¸è¦ä¸ç°æœ‰çš„æœåŠ¡ç›‘å¬çš„äº‹ä»¶å†²çªï¼Œå¦åˆ™ä¼šå‡ºç°ä¸å¯é¢„çŸ¥çš„æƒ…å†µã€‚